rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================
    // USUÁRIOS
    // =====================================
    match /usuarios/{userId} {

      allow read: if request.auth != null
        && (
          request.auth.uid == userId
          || request.auth.token.role == "admin"
          || resource.data.role == "doctor"
        );

      allow create: if request.auth != null
        && request.auth.uid == userId
        && !("role" in request.resource.data);

      allow update: if request.auth != null
        && request.auth.uid == userId
        && request.resource.data != null
        && (
          !("role" in request.resource.data)
          || request.resource.data.role == resource.data.role
        );

      allow delete: if request.auth != null
        && request.auth.uid == userId;
    }

    // =====================================
    // HORÁRIOS
    // =====================================
    match /availability_slots/{slotId} {

      allow read: if request.auth != null;

      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.medicoId
        && request.auth.token.role == "doctor";

      allow update, delete: if request.auth != null
        && request.auth.uid == resource.data.medicoId
        && request.auth.token.role == "doctor";
    }

    // =====================================
    // CONSULTAS
    // =====================================
    match /appointments/{appointmentId} {

      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.pacienteId
        && request.auth.token.role == "patient"
        && (request.resource.data.unidade is string);

      allow read: if request.auth != null
        && (
          request.auth.uid == resource.data.pacienteId ||
          request.auth.uid == resource.data.medicoId ||
          request.auth.token.role == "admin"
        );

      allow update: if request.auth != null
        && (
          request.auth.uid == resource.data.pacienteId ||
          request.auth.uid == resource.data.medicoId
        )
        && request.resource.data.pacienteId == resource.data.pacienteId
        && request.resource.data.medicoId == resource.data.medicoId
        && request.resource.data.status in [
          "agendado", "cancelada", "concluida", "retorno"
        ];

      allow delete: if request.auth != null
        && (
          request.auth.uid == resource.data.pacienteId ||
          request.auth.uid == resource.data.medicoId
        );
    }

    // =====================================
    // CONVÊNIOS / PLANOS DE SAÚDE (AGRUPADOS)
    // =====================================
    match /planos_saude/{convenioId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.role == "admin";

      match /categorias/{catId} {
        allow read: if request.auth != null;
        allow write: if request.auth.token.role == "admin";
      }
    }

    // =====================================
    // ADMIN GLOBAL (fallback)
    // =====================================
    match /{document=**} {
      allow read, create, update: if request.auth != null
        && request.auth.token.role == "admin";
      // delete proibido
    }
  }
}
